# Measures of diagnostic test accuracy {#sec-diagnostic_accuracy}

```{r}
#| include: false
library(fontawesome)
```

When we have finished this Chapter, we should be able to:

::: {.callout-caution icon="false"}
## Learning objectives

-   Evaluate a diagnostic test with dichotomous test result
-   Interpret the results
:::

## Research question

To estimate the diagnostic accuracy of digital mammography (index test) in the detection of breast cancer, using histopathology as a "gold standard" in women aged over 40 years, who are undergoing mammography for the evaluation of different symptoms related to breast diseases.

## Packages we need

We need to load the following packages:

```{r}
#| message: false
#| warning: false

library(ggmosaic)
library(epiR)

library(here)
library(tidyverse)
```

## Contingency 2x2 table

Generally, an individual's disease status is a dichotomous variable; the individual either has the disease ($Outcome+$) or hasn't the disease ($Outcome-$) as defined by the reference standard (or "gold" standard). The diagnostic test under evaluation (also named as index test) can be measured with a dichotomous variable (e.g. presence or absence of breast abnormalities using an X-ray) or a continuous variable (e.g. fasting glucose level for diabetes diagnosis), that can be transformed to a dichotomous variable by choosing an optimal cut-off value (threshold) which distinguishes positive ($Test+$) from negative ($Test-$) test results.

If the index test gives a dichotomous result for each participant in a study, the data can be tabulated in a 2 x 2 table of test result ($Test+$, $Test-$) versus "true" disease status ($Outcome+$, $Outcome-$). For example, the result of digital mammography test to diagnose breast cancer compared to the "gold" standard biopsy/surgery and histopathology in 1220 women with suspected breast cancer are following:

|                       |         | Outcome according to the reference standard |                                    |                                 |
|:-------------:|:-------------:|:-------------:|:-------------:|:-------------:|
|                       |         |     $Outcome+$ <br /> (Disease present)     | $Outcome-$ <br /> (Disease absent) |             Totals              |
| **Index Test result** | $Test+$ |                 **TP**=890                  |             **FP**=110             |           TP+FP=1000            |
|                       | $Test-$ |                  **FN**=20                  |             **TN**=200             |            TN+FN=220            |
|                       | Totals  |                  TP+FN=910                  |             TN+FP=310              | **N**=1220 <br /> (TP+TN+FP+FN) |

: A 2 × 2 table reporting cross-classification of individuals by index and reference test result. {#tbl-tbl1}

where

TP: true positive; test positive and disease present (Test+ ∩ Outcome+)

FP = false positive; test positive and disease absent (Test+ ∩ Outcome-)

FN = false negative; test negative and disease present (Test- ∩ Outcome+)

TN = true negative; test negative and disease absent (Test- ∩ Outcome-)

## Diagnostic Accuracy Measures

::: content-box-green
**Basic Diagnostic Accuracy Measures**

The **Sensitivity (Sn)** of a diagnostic test refers to the ability of the test to correctly identify those individuals with the disease. It is defined as the proportion of true positive test results among individuals who have the disease.

Sn = $\frac{TP}{TP+FN}=\frac{890}{910}=0.978$ or $97.8\%$

The **Specificity (Sp)** of a diagnostic test refers to the ability of the test to correctly identify those patients without the disease. It is defined as the proportion of true negative test results among individuals who do not have the disease.

Sp = $\frac{TN}{TN+FP}=\frac{200}{310}=0.645$ or $64.5\%$

**Positive Predictive Value (PPV)** is the probability that individuals with a positive diagnostic test result actually have the disease. It is defined as the proportion of true positive test results among individuals who have a positive test.

PPV = $\frac{TP}{TP+FP}=\frac{890}{1000}=0.890$ or $89.0\%$

**Negative Predictive Value (NPV)** is the probability that individuals with a negative diagnostic test result are truly free from the disease. It is defined as the proportion of true negative test results among individuals who have a negative test.

NPV = $\frac{TN}{TN+FN}=\frac{200}{220}=0.909$ or $90.9\%$
:::

::: callout-important
## NOTE

Positive and negative predictive values are influenced by the prevalence of disease in the population that is being tested. Using the same test in a population with a higher prevalence (e.g. women over the age of 55) increases positive predictive value. Conversely, increased prevalence results in decreased negative predictive value. Therefore, when considering predictive values of diagnostic or screening tests, we should take into account the influence of the prevalence of the disease.
:::

And other useful diagnostic measures are following:

::: content-box-green
**More Diagnostic Accuracy Measures**

**Apparent prevalence** is the proportion of individuals with a positive test result.

Apparent prevalence = $\frac{TP + FP}{N}=\frac{1000}{1220}=0.820$ or $82.0\%$

**True prevalence** is the proportion of individuals that are truly diseased.

True prevalence = $\frac{TP + FN}{N}=\frac{910}{1220}=0.746$ or $74.6\%$

The **Likelihood ratio for a positive test result (LR+)** is the probability of an individual who has the disease testing positive divided by the probability of an individual who does not have the disease testing positive. It is calculated as sensitivity divided by 1 minus the specificity value.

LR+ = $\frac{Sn}{1-Sp}=\frac{0.978}{1-0.645}=\frac{0.978}{0.355}= 2.755$

The **Likelihood ratio for a negative test result (LR-)** is the probability of an individual who has the disease testing negative divided by the probability of an individual who does not have the disease testing negative. It is calculated as 1 minus the sensitivity  divided by specificity value.

LR- = $\frac{1-Sn}{Sp}=\frac{1-0.978}{0.645}=\frac{0.022}{0.645}= 0.034$

**Diagnostic accuracy** (effectiveness), expressed as a proportion of correctly classified subjects (TP+TN) among all subjects (N). Diagnostic accuracy is affected by the disease prevalence.

Accuracy = $\frac{TP + TN}{N}=\frac{890 + 200}{1220}=\frac{1090}{1220}= 0.893$ or $89.3\%$
:::

In R:

```{r}
tb1 <- as.table(
  rbind(c(890, 110), c(20, 200))
  )

dimnames(tb1) <- list(
  Test = c("Test +", "Test -"),
  Outcome = c("Outcome +", "Outcome -")
)

tb1
```

From this contingency table, we can create a basic mosaic plot.

::: {#exercise-joins .callout-important icon="false"}
## `r fa("r-project", fill = "#0008C1")` Mosaic plot for a 2x2 table

::: panel-tabset
## graphics

```{r}
mosaicplot(t(tb1), col = c("goldenrod1", "firebrick"), 
           cex.axis = 0.9, main=NULL)
```

## ggmosaic

```{r}
df <- reshape2::melt(tb1)

p <- ggplot(df) + 
  geom_mosaic(aes(weight = value, x = product(Test, Outcome)),
              fill = c("goldenrod1", "firebrick",  "goldenrod1", "firebrick"))

df2 <- ggplot_build(p)$data[[1]][3:6]

df2$percentage <- round(100*df$value/sum(df$value), 2)

df2$lab <- paste0(df$value, " (", df2$percentage, "%", ")")

p + geom_label(data = df2, 
               aes(x = (xmin+xmax)/2, y = (ymin+ymax)/2, label = lab))

```
:::
:::

```{r}
epi.tests(tb1, digits = 3)
```
