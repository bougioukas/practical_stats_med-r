# One-way Repeated Measures ANOVA {#sec-repeated_anova}

```{r}
#| include: false

library(fontawesome)
```

The one-way repeated measures analysis of variance (also known as a within-subjects ANOVA) is an extension of the paired t-test designed to assess whether there are significant differences in the means of three or more related groups, such as comparing the difference between three or more time points.

::: {.callout-caution icon="false"}
## `r fa("circle-dot", prefer_type = "regular", fill = "red")` Learning objectives

-   Applying hypothesis testing
-   Compare three or more dependent samples applying repeated ANOVA
-   Perform post-hoc tests
-   Interpret the results
:::

## Research question and Hypothesis Testing

Participants used margarine for 12 weeks. Their blood total cholesterol (TCH; in mmol/L) was measured before the special diet, after 6 weeks and after 12 weeks.

::: {.callout-note icon="false"}
## `r fa("angles-right", fill = "#1DC5CE")` Null hypothesis and alternative hypothesis for the main research question

-   $H_0$: all related group means are equal (the means of cholesterol at the three time points are equal; $\mu_{1} = \mu_{2} = \mu_{3}$)
-   $H_1$: at least one related group mean differs from the others (there is at least one time point at which the mean cholesterol level differs from the others)
:::

## Packages we need

We need to load the following packages:

```{r}
#| message: false
#| warning: false

library(rstatix)
library(superb)
library(ggpubr)
library(ggprism)
library(ggsci)
library(ggpubr)
library(ggrain)

library(PupillometryR)
library(gtsummary)
library(dabestr)

library(here)
library(tidyverse)
```

## Preparing the data

We import the data *cholesterol* in R:

```{r}
#| warning: false

library(readxl)
dat_TCH <- read_excel(here("data", "cholesterol.xlsx"))
```

```{r}
#| echo: false
#| label: fig-cholesterol
#| fig-cap: Table with data from "cholesterol" file.

DT::datatable(
  dat_TCH, extensions = 'Buttons', options = list(
    dom = 'tip',
    columnDefs = list(list(className = 'dt-center', targets = "_all"))
  )
)

```

We inspect the data and the type of variables:

```{r}
glimpse(dat_TCH)
```

## Assumptions

::: {.callout-note icon="false"}
## Check if the following assumptions are satisfied

A.  The data are **normally** distributed in all time points.
B.  The **variances** among the differences between all possible pairs of time points are equal (sphericity assumption).
:::

**A. Explore the characteristics of distribution for each time point and check for normality**

The distributions can be explored visually with appropriate plots. Additionally, summary statistics and significance tests to check for normality (e.g., Shapiro-Wilk test) can be used.

**Graphs**

We can visualize the distribution of `cholesterol` for the three time points:

```{r}
dat_TCH_long <- dat_TCH |> 
  mutate(id = row_number()) |> 
  pivot_longer(cols = -id, names_to = "time", values_to = "cholesterol") |> 
  mutate(time = factor(time, levels = c("week0", "week6", "week12")))
```

```{r}
#| warning: false
#| label: fig-violin_plot3
#| fig-cap: Rain cloud plot.

ggplot(dat_TCH_long, aes(x= time, y = cholesterol, fill = time)) +
  geom_rain(likert= TRUE, seed = 123, point.args = list(alpha = 0.3)) +
  theme_prism(base_size = 14, base_line_size = 0.4, palette = "office") +
  labs(title = "Grouped Raincloud Plot: Cholesterol by time point") +
  scale_fill_jco() +
  theme(legend.position = "none")
```

```{r}
ggqqplot(dat_TCH_long, "cholesterol", color = "time", conf.int = F) +
  theme_prism(base_size = 14, base_line_size = 0.4, palette = "office") +
  scale_color_jco() +
  facet_wrap(~ time) + 
  theme(legend.position = "none")
```

The above figures show that the data are close to symmetry and the assumption of a normal distribution is reasonable.

**Summary statistics**

The `cholesterol` summary statistics for each time point are:

::: {#exercise-joins .callout-tip}
## Summary statistics by time point

::: panel-tabset
## dplyr

```{r}
cholesterol_summary <- dat_TCH_long %>%
  group_by(time) %>%
  dplyr::summarise(
    n = n(),
    na = sum(is.na(cholesterol)),
    min = min(cholesterol, na.rm = TRUE),
    q1 = quantile(cholesterol, 0.25, na.rm = TRUE),
    median = quantile(cholesterol, 0.5, na.rm = TRUE),
    q3 = quantile(cholesterol, 0.75, na.rm = TRUE),
    max = max(cholesterol, na.rm = TRUE),
    mean = mean(cholesterol, na.rm = TRUE),
    sd = sd(cholesterol, na.rm = TRUE),
    skewness = EnvStats::skewness(cholesterol, na.rm = TRUE),
    kurtosis= EnvStats::kurtosis(cholesterol, na.rm = TRUE)
  ) %>%
  ungroup()

cholesterol_summary
```

## dlookr

```{r}
dat_TCH_long |> 
  group_by(time) |> 
  dlookr::describe(cholesterol) |> 
  select(described_variables,  time, n, mean, sd, p25, p50, p75, skewness, kurtosis) |> 
  ungroup() |> 
  print(width = 100)
```
:::
:::

The means are close to medians and the standard deviations are also similar. Moreover, both skewness and (excess) kurtosis falls into the acceptable range of \[-1, 1\] indicating approximately normal distributions for all time points.

Â 

**Normality test**

```{r}
dat_TCH_long |> 
  group_by(time) |> 
  shapiro_test(cholesterol) |>  
  ungroup()
```

The tests of normality suggest that the data for the `cholesterol` in all time points are normally distributed (p \> 0.05).

::: content-box-green
In our example, the data at each time point are approximately normally distributed; a repeated ANOVA analysis can be performed.
:::

**B. Sphericity test for equality of variances of the differences**

In addition, the assumption of sphericity must be met for accurate interpretation of the results of repeated ANOVA. This assumption is usually checked with the **Mauchly's sphericity test**, wherein null hypothesis states that the variances of the differences are equal.

```{r}
MauchlySphericityTest(dat_TCH)
```

Here the assumption of sphericity has not been met (p \< 0.001). In this case, we have to correct the degrees of freedom in repeated ANOVA analysis.



## Run the one-way repeated ANOVA test

First, let's run the repeated ANOVA test without any correction:

```{r}
repeated_anova <- dat_TCH_long |>
  anova_test(dv = cholesterol, wid = id, within = time)

repeated_anova[1]
```


However, we must adjust the results of the repeated ANOVA analysis. The correction involves multiplying the degrees of freedom DFn=2 and DFd=34 by a quantity *e*, which measures the extent to which the data deviates from ideal sphericity (*e* ranges between 0 and 1, where 1 indicates no departure from sphericity). Two methods are commonly used for calculating *e*:

- the correction of Greenhouse-Geisser (GGe).  
- the correction of Huynh-Feldt (HFe).





In R, we can calculate both GGe and HFe, as follows:

```{r}
repeated_anova[3]
```


::: content-box-green

The general recommendation is to use the Greenhouse-Geisser correction when GGe is less than 0.75; otherwise, we should use the Huynh-Feldt correction HFe.
:::


As the GGe value is less than 0.75, we use the Greenhouse-Geisser adjustment of 0.618. The corrected degrees of freedom are:

$DF[GG]_n=2*0.618=1.24$ 

and 

$DF[GG]_d=34*0.618=21$.


The new p-value (p[GG]) is available next to the corrected degrees of freedom (DF[GG]). In this example, as p<0.001 there is evidence of a difference between at least two time points.


::: {#exercise-joins .callout-tip}
## `get_anova_table()`


By utilizing the `get_anova_table()` function to extract the ANOVA table, the Greenhouse-Geisser sphericity correction is automatically applied when the assumption of sphericity is violated.


```{r}
get_anova_table(repeated_anova)
```
:::


